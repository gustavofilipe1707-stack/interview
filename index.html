<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>HSR Unified - RS Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b111a; --card: #161e2b; --blue: #00a2ff; --green: #00e676; --red: #ff5252; --yellow: #ffeb3b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #cfd8dc; margin: 0; padding: 20px; }
        #mode-selector { max-width: 400px; margin: 80px auto; text-align: center; background: var(--card); padding: 40px; border-radius: 15px; border: 1px solid var(--blue); }
        .btn-mode { border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px; transition: 0.3s; }
        .btn-agente { background: var(--blue); color: white; }
        .btn-monitor { background: #37474f; color: white; }
        #view-agente, #view-monitor { display: none; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 6px solid var(--blue); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #232d3d; }
        .val { color: #fff; font-weight: bold; font-family: 'Consolas', monospace; }
        .editable-name { background: rgba(0,162,255,0.2); border: 1px dashed var(--blue); padding: 2px 10px; border-radius: 4px; cursor: pointer; }
        .station-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .station-card { background: var(--card); border-radius: 10px; padding: 15px; border-left: 6px solid #444; }
        .status-internet-ruim { border-left-color: var(--red); animation: pulse 2s infinite; }
        .status-cpu-ruim { border-left-color: var(--yellow); }
        .status-ok { border-left-color: var(--green); }
        .status-offline { border-left-color: #455a64; opacity: 0.6; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); } }
    </style>
</head>
<body>

    <div id="mode-selector">
        <h2 style="color:var(--blue)">SISTEMA HSR</h2>
        <button class="btn-mode btn-agente" onclick="switchView('agente')">MODO AGENTE</button>
        <button class="btn-mode btn-monitor" onclick="checkPass()">MODO MONITORAMENTO</button>
    </div>

    <div id="view-agente" style="max-width:600px; margin:auto;">
        <div class="card">
            <h2>ESTAÃ‡ÃƒO: <span id="st-id" class="editable-name" onclick="changeName()">---</span></h2>
            <div class="info-row"><span>IP:</span> <span id="ip-res" class="val">Detectando...</span></div>
            <div class="info-row"><span>ISP:</span> <span id="isp-res" class="val">Detectando...</span></div>
        </div>
        <div class="card">
            <h2>MONITORAMENTO</h2>
            <div class="info-row"><span>Ping:</span> <span id="ping-val" class="val">--</span></div>
            <div class="info-row"><span>CPU:</span> <span id="cpu-val" class="val">--</span></div>
            <div class="info-row"><span>MÃ©dia:</span> <span id="media-val" class="val">--</span></div>
        </div>
        <button onclick="saveAsJpeg()" style="background:var(--green); border:none; padding:15px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer;">ðŸ“¸ GERAR PRINT</button>
    </div>

    <div id="view-monitor">
        <h1 style="text-align:center">CONTROLE HSR</h1>
        <div id="stations-container" class="station-grid"></div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBxu-QXp3lkb1JMW-wmdS7drOYNuNL-3iw",
        authDomain: "interview-69ef5.firebaseapp.com",
        databaseURL: "https://interview-69ef5-default-rtdb.firebaseio.com/",
        projectId: "interview-69ef5",
        storageBucket: "interview-69ef5.firebasestorage.app",
        messagingSenderId: "877203281572",
        appId: "1:877203281572:web:c86ee64b4d5d32d11ff831"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let pingHistory = [];

    // --- DETECÃ‡ÃƒO DE IP (MÃ‰TODO BLINDADO) ---
    function fetchNetInfo() {
        const script = document.createElement('script');
        script.src = 'https://ipapi.co/jsonp/?callback=updateNet';
        document.body.appendChild(script);
    }
    function updateNet(data) {
        document.getElementById('ip-res').innerText = data.ip || "N/A";
        document.getElementById('isp-res').innerText = data.org || "N/A";
    }

    // --- GESTÃƒO DE NOMES ---
    function initName() {
        let name = localStorage.getItem('hsr_name');
        if(!name) {
            name = "HSR-" + Math.floor(1000 + Math.random() * 9000);
            localStorage.setItem('hsr_name', name);
        }
        document.getElementById('st-id').innerText = name;
    }
    function changeName() {
        const newName = prompt("Mudar nome da estaÃ§Ã£o:", document.getElementById('st-id').innerText);
        if(newName) {
            localStorage.setItem('hsr_name', newName);
            location.reload();
        }
    }

    function switchView(m) {
        document.getElementById('mode-selector').style.display = 'none';
        if(m === 'agente') {
            document.getElementById('view-agente').style.display = 'block';
            initName(); fetchNetInfo(); startAgente();
        } else {
            document.getElementById('view-monitor').style.display = 'block';
            startMonitor();
        }
    }

    function checkPass() { if(prompt("Senha:") === 'hsr') switchView('monitor'); }

    function startAgente() {
        setInterval(() => {
            const start = Date.now();
            const img = new Image();
            img.src = "https://hsrpbx.com.br/favicon.ico?t=" + start;
            img.onload = () => {
                const delta = Date.now() - start;
                document.getElementById('ping-val').innerText = delta + " ms";
                pingHistory.push(delta);
                if(pingHistory.length > 100) pingHistory.shift();
                const avg = Math.round(pingHistory.reduce((a,b)=>a+b,0)/pingHistory.length);
                document.getElementById('media-val').innerText = avg + " ms";
                
                db.ref('stations/' + localStorage.getItem('hsr_name')).update({
                    name: localStorage.getItem('hsr_name'),
                    ip: document.getElementById('ip-res').innerText,
                    isp: document.getElementById('isp-res').innerText,
                    latency: delta + " ms",
                    avg: avg + " ms",
                    cpu: document.getElementById('cpu-val').innerText,
                    lastSeen: Date.now()
                });
            };
        }, 5000);
        
        // Check CPU a cada 10 min
        const checkCPU = () => {
            const s = performance.now(); let c = 0; while(performance.now()-s < 150) c++;
            document.getElementById('cpu-val').innerText = c > 400000 ? "Ok" : "Lenta";
        };
        checkCPU(); setInterval(checkCPU, 600000);
    }

    function startMonitor() {
        db.ref('stations').on('value', snap => {
            const container = document.getElementById('stations-container');
            container.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.values(data).forEach(s => {
                const isOff = (Date.now() - s.lastSeen) > 40000;
                let cls = isOff ? 'status-offline' : (parseInt(s.latency) > 80 ? 'status-internet-ruim' : (s.cpu === 'Lenta' ? 'status-cpu-ruim' : 'status-ok'));
                container.innerHTML += `<div class="station-card ${cls}">
                    <div style="font-weight:bold">${s.name}</div>
                    <div style="font-size:0.8rem">IP: ${s.ip} | Ping: ${s.latency}</div>
                    <div style="font-size:0.8rem">CPU: ${s.cpu} | Status: ${isOff?'Offline':'Online'}</div>
                </div>`;
            });
        });
    }

    function saveAsJpeg() {
        html2canvas(document.querySelector("#view-agente")).then(c => {
            const l = document.createElement('a'); l.download = "HSR.jpg"; l.href = c.toDataURL(); l.click();
        });
    }
</script>
</body>
</html>
