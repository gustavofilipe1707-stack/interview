<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>HSR - Sistema Unificado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg: #0b111a; --card: #161e2b; --blue: #00a2ff; --green: #00e676; --red: #ff5252; --yellow: #ffeb3b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #cfd8dc; margin: 0; padding: 20px; }
        
        /* Seletor de Modo */
        #mode-selector { max-width: 400px; margin: 100px auto; text-align: center; background: var(--card); padding: 40px; border-radius: 15px; border: 1px solid var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn-mode { border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px; font-size: 1rem; transition: 0.3s; }
        .btn-agente { background: var(--blue); color: white; }
        .btn-monitor { background: #37474f; color: white; }

        /* Agente */
        #view-agente, #view-monitor { display: none; }
        .agente-container { max-width: 600px; margin: auto; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 6px solid var(--blue); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #232d3d; }
        .val { color: #fff; font-weight: bold; font-family: 'Consolas', monospace; }
        
        /* Dashboard Monitor */
        .header-mon { text-align: center; padding-bottom: 20px; border-bottom: 2px solid var(--blue); margin-bottom: 20px; }
        .stats-bar { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .stat-item { background: var(--card); padding: 10px 15px; border-radius: 8px; border: 1px solid #333; font-size: 0.8rem; }
        .station-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; justify-content: center; }
        .station-card { background: var(--card); border-radius: 10px; padding: 20px; border-left: 6px solid #444; }

        /* L√≥gica de Cores */
        .status-internet-ruim { border-left-color: var(--red); animation: pulse 2s infinite; }
        .status-cpu-ruim { border-left-color: var(--yellow); }
        .status-ok { border-left-color: var(--green); }
        .status-offline { border-left-color: #455a64; opacity: 0.6; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); } }
        .badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .bg-online { background: var(--green); color: #000; }
        .bg-offline { background: #455a64; color: #fff; }
    </style>
</head>
<body>

    <div id="mode-selector">
        <h2 style="color:var(--blue)">SISTEMA HSR</h2>
        <button class="btn-mode btn-agente" onclick="switchView('agente')">MODO AGENTE</button>
        <button class="btn-mode btn-monitor" onclick="checkPass()">MODO MONITORAMENTO</button>
    </div>

    <div id="view-agente" class="agente-container">
        <div class="card">
            <h2>ESTA√á√ÉO: <span id="st-id" style="background:var(--blue); padding:3px 8px; border-radius:4px;">---</span></h2>
            <div class="info-row"><span>IP P√∫blico:</span> <span id="ip-res" class="val">Buscando...</span></div>
            <div class="info-row"><span>Operadora:</span> <span id="isp-res" class="val">Buscando...</span></div>
        </div>
        <div class="card">
            <h2>SA√öDE DA CONEX√ÉO</h2>
            <div class="info-row"><span>Lat√™ncia Atual:</span> <span id="ping-val" class="val">--</span></div>
            <div class="info-row"><span>M√©dia (30m):</span> <span id="media-val" class="val">--</span></div>
            <div class="info-row"><span>Processador:</span> <span id="cpu-val" class="val">--</span></div>
        </div>
        <button onclick="saveAsJpeg()" style="background:var(--green); border:none; padding:12px; border-radius:6px; font-weight:bold; width:100%; cursor:pointer; color:#0b111a;">üì∏ SALVAR JPEG</button>
    </div>

    <div id="view-monitor">
        <div class="header-mon">
            <h1>PAINEL DE CONTROLE HSR</h1>
            <div class="stats-bar">
                <div class="stat-item">Online: <b id="count-online" style="color:var(--green)">0</b></div>
                <div class="stat-item">Offline: <b id="count-offline" style="color:gray">0</b></div>
                <div class="stat-item">Cr√≠tico (Internet): <b id="count-net" style="color:var(--red)">0</b></div>
                <div class="stat-item">Alerta (CPU): <b id="count-cpu" style="color:var(--yellow)">0</b></div>
            </div>
        </div>
        <div id="stations-container" class="station-grid"></div>
    </div>

<script>
    // --- FIREBASE CONFIG GUSTAVO ---
    const firebaseConfig = {
        apiKey: "AIzaSyBxu-QXp3lkb1JMW-wmdS7drOYNuNL-3iw",
        authDomain: "interview-69ef5.firebaseapp.com",
        databaseURL: "https://interview-69ef5-default-rtdb.firebaseio.com/",
        projectId: "interview-69ef5",
        storageBucket: "interview-69ef5.firebasestorage.app",
        messagingSenderId: "877203281572",
        appId: "1:877203281572:web:c86ee64b4d5d32d11ff831"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let pingHistory = [];
    let myMachineName = "";

    function checkPass() {
        if(prompt("Senha de acesso:") === 'hsr') switchView('monitor');
        else alert("Acesso negado");
    }

    function switchView(mode) {
        document.getElementById('mode-selector').style.display = 'none';
        if(mode === 'agente') {
            document.getElementById('view-agente').style.display = 'block';
            initAgente();
        } else {
            document.getElementById('view-monitor').style.display = 'block';
            initMonitor();
        }
    }

    function initAgente() {
        myMachineName = localStorage.getItem('hsr_name');
        if(!myMachineName) {
            myMachineName = prompt("Nome da Esta√ß√£o (ex: INTERVIEW001):", "INTERVIEW001");
            localStorage.setItem('hsr_name', myMachineName);
        }
        document.getElementById('st-id').innerText = myMachineName;
        
        fetchNetInfo();
        checkCPU();
        setInterval(measurePing, 5000);
        setInterval(checkCPU, 600000); // 10 min
        setInterval(syncToFirebase, 10000); // Sincroniza a cada 10s
    }

    function fetchNetInfo() {
        fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
            document.getElementById('ip-res').innerText = data.ip || "N/A";
            document.getElementById('isp-res').innerText = data.org || "N/A";
        }).catch(() => { document.getElementById('ip-res').innerText = "Erro Rede"; });
    }

    function measurePing() {
        const start = Date.now();
        const img = new Image();
        img.src = "https://hsrpbx.com.br/favicon.ico?t=" + start;
        img.onload = img.onerror = () => {
            const delta = Date.now() - start;
            document.getElementById('ping-val').innerText = delta + " ms";
            pingHistory.push(delta);
            if(pingHistory.length > 360) pingHistory.shift();
            const avg = Math.round(pingHistory.reduce((a,b)=>a+b,0) / pingHistory.length);
            document.getElementById('media-val').innerText = avg + " ms";
        };
    }

    function checkCPU() {
        const cStart = performance.now();
        let count = 0; while (performance.now() - cStart < 150) { count++; }
        const cpuStatus = count > 400000 ? "Excelente" : "Ocupado";
        document.getElementById('cpu-val').innerText = cpuStatus;
    }

    function syncToFirebase() {
        if(!myMachineName) return;
        db.ref('stations/' + myMachineName).set({
            name: myMachineName,
            ip: document.getElementById('ip-res').innerText,
            isp: document.getElementById('isp-res').innerText,
            latency: document.getElementById('ping-val').innerText,
            avg: document.getElementById('media-val').innerText,
            cpu: document.getElementById('cpu-val').innerText,
            lastSeen: Date.now()
        });
    }

    function initMonitor() {
        db.ref('stations').on('value', (snap) => {
            const data = snap.val();
            const container = document.getElementById('stations-container');
            container.innerHTML = "";
            if(!data) return;

            let counts = { online: 0, offline: 0, net: 0, cpu: 0 };
            const now = Date.now();

            Object.values(data).forEach(st => {
                const isOff = (now - st.lastSeen) > 60000; // 1 min sem sinal = offline
                let status = "ok";
                
                if(isOff) { counts.offline++; status="offline"; }
                else {
                    counts.online++;
                    if(parseInt(st.latency) > 80) { status="internet-ruim"; counts.net++; }
                    else if(st.cpu === "Ocupado") { status="cpu-ruim"; counts.cpu++; }
                }

                container.innerHTML += `
                    <div class="station-card status-${status}">
                        <div style="font-weight:bold; margin-bottom:10px">${st.name} <span class="badge ${isOff?'bg-offline':'bg-online'}">${isOff?'offline':'online'}</span></div>
                        <div style="font-size:0.8rem">IP: ${st.ip}</div>
                        <div style="font-size:0.8rem">Sa√∫de: <b>${st.latency}</b></div>
                        <div style="font-size:0.8rem">M√©dia (30m): <b>${st.avg}</b></div>
                        <div style="font-size:0.8rem">CPU: <b>${st.cpu}</b></div>
                    </div>`;
            });
            document.getElementById('count-online').innerText = counts.online;
            document.getElementById('count-offline').innerText = counts.offline;
            document.getElementById('count-net').innerText = counts.net;
            document.getElementById('count-cpu').innerText = counts.cpu;
        });
    }

    function saveAsJpeg() {
        html2canvas(document.querySelector("#view-agente")).then(canvas => {
            const link = document.createElement('a');
            link.download = myMachineName + ".jpg"; link.href = canvas.toDataURL('image/jpeg'); link.click();
        });
    }
</script>
</body>
</html>
